<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JSNotebook Prototype</title>

  <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="notebook">
    <!-- STATIC ELEMENTS -->
    <section class="preamble">
      <p>Below is a simple interactive <strong>prototype</strong> of a notebook
      shell UI. You can enter JavaScript statements and see the results of
      evaluating them by pressing "return". Enter a multi-line statement by
      holding shift and pressing "return".</p>
      <p>You can refer back to previous results via the global
      <code>results[]</code>.</p>
      <p>You can create a text comment by entering <code>/*</code> in the code
        cell. End the comment by entering <code>*/</code>.</p>
    </section>

    <section id="cell-title" class="cell cell-title">
      <textarea placeholder="Notebook Title">Sample Notebook Title</textarea>
    </section>

    <!-- PROTO ELEMENTS -->
    <div id="proto-controls" class="cell-controls">
      <button><i class="icon-file icon-white"></i> Switch to Code</button>
      <button><i class="icon-plus icon-white"></i> Add Cell</button>
      <button><i class="icon-hdd icon-white"></i> Copy Cell</button>
      <button><i class="icon-trash icon-white"></i> Delete Cell</button>
    </div>

    <section id="proto-section" class="cell cell-code pending">
      <span class="cell-tag">0</span>
      <div class="cell-internal-wrapper">
        <div class="cell-primary">
          <span class="cell-handle"><i class="icon-move"></i></span>
          <textarea name="" id="" cols="30" rows="10" style="height: 25px;"></textarea>
        </div>
        <pre class="cell-results pending"></pre>
      </div>
    </section>

  </div>

<script src="jquery.min.js"></script>
<script src="jquery.autosize.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
<script>
// Hack - global for results
var results = [];

$(function(jQuery){
  var _cellIds = 0;
  var _$protoSection = $('#proto-section');
  var _$protoControls = $('#proto-controls');

  function _onTextAreaFocus() {
    var parent = $(this).parents('.cell');
    parent.addClass('active');
  }

  function _onTextAreaBlur() {
    var parent = $(this).parents('.cell');
    parent.removeClass('active');
  }

  // For handling return keypresses
  function _onCodeCellKeypress(e) {
    if (e.keyCode === 13 && e.shiftKey === false) {
      // Otherwise, parse and render results
      e.preventDefault();
      var $currentCell = $(this).parents('.cell');
      renderResults($currentCell);
      addCell($currentCell);
      return false;
    }
  }
  
  // For handling keyup (changing cell mode by entering code block text
  function _onCellKeyup(e) {
    var $el = $(this);
    var $parent = $($el.parents('.cell').get(0));
    var value = e.target.value;
    // If block comment was just started, change cell to text cell
    if (value === '/*') {
      $parent
        .removeClass('cell-code')
        .addClass('cell-text')
        .remove('.cell-results')
        .find('textarea')
          .off('keypress', _onCodeCellKeypress)
          .val(value + "\n\t")
          .trigger('input')
    // If block comment ends, finalize text cell
    } else if ($parent.hasClass('cell-text') && value.substr(-2) === '*/') {
      addCell($parent);
    }
  }

  function renderResults($cell) {
    var cellIndex = window.parseInt($cell.attr('id').substr(5), 10);
    var statement = $cell.find('textarea').val();
    var result;
    try {
      result = (1,eval)(statement);
    } catch(error) {
      result = error;
    }
    results[cellIndex] = result;
    // Implicitly call result.toString()
    resultText =  (typeof result === 'undefined') ? 'undefined' : result;
    $cell.find('.cell-results')
      .text(resultText)
      .removeClass('pending');
  }

  function addCell($currentCell) {
    // Only add cell if current cell is the last in list
    if ($currentCell.attr('id') === 'cell-' + (_cellIds - 1) || _cellIds === 0) {
      // Grab a fersh index
      var cellIndex = _cellIds++;
      // Clone a cell and inject a controls-section
      var $newCell = _$protoSection.clone().attr({id: 'cell-' + cellIndex});
      var $controls = _$protoControls.clone().attr(
        {id: 'cell-controls-' + cellIndex}
      );
      $newCell.prepend($controls);
      $newCell.find('.cell-tag').text(cellIndex);
      $currentCell.after($newCell);
      // initialize stuff
      $newCell
        .removeClass('pending')
        .find('textarea')
          .on('focus', _onTextAreaFocus)
          .on('blur', _onTextAreaBlur)
          .on('keypress', _onCodeCellKeypress)
          .on('keyup', _onCellKeyup)
          .autosize()
          .focus();
    }
  }

  // INIT
  addCell($('#cell-title'));
});
</script>
</body>
</html>